#!/usr/bin/env ruby

require 'aws-sdk-s3'
require 'uri'

unless ENV['AWS_S3_URI']
  puts "Error: AWS_S3_URI environment variable is required"
  exit 1
end

uri = URI.parse(ENV['AWS_S3_URI'].strip)
s3 = Aws::S3::Resource.new(
  access_key_id: uri.user,
  secret_access_key: uri.password,
  region: uri.host.split('.')[0]
)

path_parts = uri.path.sub(%r{^/}, '').split('/')
bucket_name = path_parts[0]
prefix = path_parts[1..].join('/') if path_parts.length > 1

if prefix.empty?
  puts "Error: AWS_S3_URI must include a folder path (e.g., s3://key:secret@region.amazonaws.com/bucket/folder)"
  exit 1
end

bucket = s3.bucket(bucket_name)
puts "Deleting objects in s3://#{bucket_name}/#{prefix}..."
deleted_count = bucket.objects(prefix: prefix).batch_delete!.sum { |r| r.deleted.count }
puts "Deleted #{deleted_count} objects"
